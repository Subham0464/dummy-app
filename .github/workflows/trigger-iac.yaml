name: trigger-dummy-iac

on:
  push:
    branches: ["main"]

permissions:
  contents: read

jobs:
  trigger-iac:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger dummy-iac repository_dispatch
        env:
          TOKEN: ${{ secrets.DUMMY_IAC_TRIGGER_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          APP_IMAGE_ID: ghcr.io/${{ github.repository_owner }}/demo-app:${{ github.sha }}
        run: |
          set -euo pipefail

          curl --fail-with-body -sS -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${TOKEN}" \
            "https://api.github.com/repos/${OWNER}/dummy-iac/dispatches" \
            -d "{
              \"event_type\": \"dummy-app-main-push\",
              \"client_payload\": {
                \"app_image_id\": \"${APP_IMAGE_ID}\",
                \"static_path_in_image\": \"/usr/share/nginx/html\"
              }
            }"